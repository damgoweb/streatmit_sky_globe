# Sky Globe - ä¸–ç•Œã®ä»Šã®ç©º è©³ç´°è¨­è¨ˆæ›¸

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Browser (Client)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Streamlit  â”‚  â”‚   Pydeck    â”‚  â”‚   JavaScript    â”‚  â”‚
â”‚  â”‚   Frontend  â”‚  â”‚  3D Render  â”‚  â”‚   Controls      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 Streamlit Application                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   UI Layer  â”‚  â”‚Business Layerâ”‚  â”‚   Data Layer    â”‚  â”‚
â”‚  â”‚             â”‚  â”‚              â”‚  â”‚                 â”‚  â”‚
â”‚  â”‚ - Controls  â”‚  â”‚ - Weather    â”‚  â”‚ - API Manager   â”‚  â”‚
â”‚  â”‚ - Display   â”‚  â”‚ - Geography  â”‚  â”‚ - Cache Manager â”‚  â”‚
â”‚  â”‚ - Layout    â”‚  â”‚ - Time Calc  â”‚  â”‚ - Data Parser   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  External Services                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   OpenWeatherMap API    â”‚  â”‚    Static Data Files    â”‚â”‚
â”‚  â”‚                         â”‚  â”‚                         â”‚â”‚
â”‚  â”‚ - Current Weather       â”‚  â”‚ - Cities Database       â”‚â”‚
â”‚  â”‚ - Geocoding            â”‚  â”‚ - Countries Data        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯è©³ç´°

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç”¨é€” |
|----------|------|------------|------|
| Frontend | Streamlit | 1.28.0+ | Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ |
| 3D Visualization | Pydeck | 0.8.0+ | 3Dåœ°çƒå„€æç”» |
| HTTP Client | Requests | 2.31.0+ | APIé€šä¿¡ |
| Data Processing | Pandas | 2.0.0+ | ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ»å¤‰æ› |
| Math Operations | NumPy | 1.24.0+ | æ•°å€¤è¨ˆç®— |
| Timezone | Pytz | 2023.3+ | ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç† |
| Geography | Geopy | 2.3.0+ | åœ°ç†è¨ˆç®— |

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### 2.1 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
sky_globe/
â”œâ”€â”€ app.py                      # ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ requirements.txt            # ä¾å­˜é–¢ä¿‚
â”œâ”€â”€ .streamlit/
â”‚   â””â”€â”€ secrets.toml           # APIè¨­å®š
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ ui/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ components.py      # UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
â”‚   â”‚   â”œâ”€â”€ layouts.py         # ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç®¡ç†
â”‚   â”‚   â””â”€â”€ styles.py          # ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©
â”‚   â”œâ”€â”€ business/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ weather_service.py # å¤©æ°—æƒ…å ±å‡¦ç†
â”‚   â”‚   â”œâ”€â”€ geo_service.py     # åœ°ç†æƒ…å ±å‡¦ç†
â”‚   â”‚   â””â”€â”€ time_service.py    # æ™‚é–“è¨ˆç®—
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ api_client.py      # APIé€šä¿¡
â”‚   â”‚   â”œâ”€â”€ cache_manager.py   # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
â”‚   â”‚   â””â”€â”€ data_models.py     # ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ config.py          # è¨­å®šç®¡ç†
â”‚       â””â”€â”€ validators.py      # ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ cities.csv             # éƒ½å¸‚ãƒ‡ãƒ¼ã‚¿
â”‚   â””â”€â”€ countries.csv          # å›½ãƒ‡ãƒ¼ã‚¿
â”œâ”€â”€ assets/
â”‚   â””â”€â”€ weather_icons/         # å¤©æ°—ã‚¢ã‚¤ã‚³ãƒ³
â””â”€â”€ tests/
    â”œâ”€â”€ test_weather_service.py
    â”œâ”€â”€ test_geo_service.py
    â””â”€â”€ test_api_client.py
```

### 2.2 ã‚¯ãƒ©ã‚¹å›³

```mermaid
classDiagram
    class SkyGlobeApp {
        +run()
        -setup_ui()
        -handle_events()
    }
    
    class WeatherService {
        -api_client: APIClient
        +get_current_weather(city: str)
        +get_weather_by_coords(lat: float, lon: float)
        -parse_weather_data(data: dict)
    }
    
    class GeoService {
        -cities_data: pd.DataFrame
        +search_cities(query: str)
        +get_random_city(continent: str)
        +calculate_day_night_boundary()
    }
    
    class TimeService {
        +get_local_time(timezone: str)
        +calculate_sun_position(lat: float, lon: float)
        +is_daylight(lat: float, lon: float)
    }
    
    class APIClient {
        -api_key: str
        -cache: CacheManager
        +call_weather_api(params: dict)
        +call_geocoding_api(params: dict)
    }
    
    class CacheManager {
        -cache_data: dict
        +get(key: str)
        +set(key: str, value: any, ttl: int)
        +is_expired(key: str)
    }
    
    class UIComponents {
        +render_sidebar()
        +render_globe()
        +render_weather_info()
        +render_search_box()
    }
    
    SkyGlobeApp --> WeatherService
    SkyGlobeApp --> GeoService
    SkyGlobeApp --> UIComponents
    WeatherService --> APIClient
    WeatherService --> TimeService
    APIClient --> CacheManager
```

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 3.1 éƒ½å¸‚ãƒ‡ãƒ¼ã‚¿æ§‹é€  (cities.csv)

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ | ä¾‹ |
|----------|----------|------|-----|
| id | int | éƒ½å¸‚ID | 1 |
| name_en | str | è‹±èªéƒ½å¸‚å | Tokyo |
| name_ja | str | æ—¥æœ¬èªéƒ½å¸‚å | æ±äº¬ |
| country_code | str | å›½ã‚³ãƒ¼ãƒ‰ | JP |
| country_en | str | è‹±èªå›½å | Japan |
| country_ja | str | æ—¥æœ¬èªå›½å | æ—¥æœ¬ |
| latitude | float | ç·¯åº¦ | 35.6895 |
| longitude | float | çµŒåº¦ | 139.6917 |
| timezone | str | ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ | Asia/Tokyo |
| continent | str | å¤§é™¸ | Asia |
| population | int | äººå£ | 13929280 |

### 3.2 å¤©æ°—ãƒ‡ãƒ¼ã‚¿æ§‹é€  (ãƒ¡ãƒ¢ãƒªä¿å­˜)

```python
@dataclass
class WeatherData:
    city_id: int
    city_name: str
    country_code: str
    coordinates: Tuple[float, float]
    temperature: float
    feels_like: float
    humidity: int
    pressure: int
    wind_speed: float
    wind_direction: int
    visibility: int
    weather_main: str
    weather_description: str
    weather_icon: str
    timezone_offset: int
    local_time: datetime
    sunrise: datetime
    sunset: datetime
    updated_at: datetime
```

## 4. APIè¨­è¨ˆ

### 4.1 å†…éƒ¨API (ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰)

#### WeatherService

```python
class WeatherService:
    def get_current_weather(self, city: str) -> WeatherData:
        """éƒ½å¸‚åã‹ã‚‰å¤©æ°—æƒ…å ±ã‚’å–å¾—"""
        
    def get_weather_by_coords(self, lat: float, lon: float) -> WeatherData:
        """åº§æ¨™ã‹ã‚‰å¤©æ°—æƒ…å ±ã‚’å–å¾—"""
        
    def is_cache_valid(self, key: str) -> bool:
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹æ€§ç¢ºèª"""
```

#### GeoService

```python
class GeoService:
    def search_cities(self, query: str, limit: int = 10) -> List[CityInfo]:
        """éƒ½å¸‚æ¤œç´¢ï¼ˆæ—¥è‹±å¯¾å¿œï¼‰"""
        
    def get_random_city(self, continent: str = None) -> CityInfo:
        """ãƒ©ãƒ³ãƒ€ãƒ éƒ½å¸‚é¸æŠ"""
        
    def calculate_day_night_boundary(self, datetime_utc: datetime) -> List[Tuple[float, float]]:
        """æ˜¼å¤œå¢ƒç•Œç·šè¨ˆç®—"""
        
    def get_city_by_id(self, city_id: int) -> CityInfo:
        """IDæŒ‡å®šéƒ½å¸‚æƒ…å ±å–å¾—"""
```

### 4.2 å¤–éƒ¨APIä»•æ§˜

#### OpenWeatherMap Current Weather API

```python
# ãƒªã‚¯ã‚¨ã‚¹ãƒˆä¾‹
GET https://api.openweathermap.org/data/2.5/weather
    ?q={city_name}
    &appid={API_key}
    &units=metric
    &lang=ja

# ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ 
{
    "coord": {"lon": 139.69, "lat": 35.69},
    "weather": [{
        "id": 800,
        "main": "Clear",
        "description": "clear sky",
        "icon": "01d"
    }],
    "main": {
        "temp": 25.5,
        "feels_like": 27.2,
        "temp_min": 23.1,
        "temp_max": 28.3,
        "pressure": 1013,
        "humidity": 60
    },
    "wind": {"speed": 3.2, "deg": 180},
    "visibility": 10000,
    "sys": {
        "country": "JP",
        "sunrise": 1679184000,
        "sunset": 1679227200
    },
    "timezone": 32400,
    "name": "Tokyo"
}
```

## 5. UI/UXè©³ç´°è¨­è¨ˆ

### 5.1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

#### 5.1.1 ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```python
def render_main_layout():
    st.set_page_config(
        page_title="Sky Globe - ä¸–ç•Œã®ä»Šã®ç©º",
        page_icon="ğŸŒ",
        layout="wide",
        initial_sidebar_state="expanded"
    )
    
    # ã‚«ã‚¹ã‚¿ãƒ CSSé©ç”¨
    st.markdown(get_custom_css(), unsafe_allow_html=True)
    
    # ãƒ˜ãƒƒãƒ€ãƒ¼
    render_header()
    
    # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    col1, col2 = st.columns([1, 2])
    with col1:
        render_sidebar()
    with col2:
        render_main_content()
```

#### 5.1.2 3Dåœ°çƒå„€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```python
def render_globe(selected_city: CityInfo, weather_data: WeatherData):
    # åœ°çƒå„€ã®åŸºæœ¬è¨­å®š
    view_state = pydeck.ViewState(
        longitude=selected_city.longitude,
        latitude=selected_city.latitude,
        zoom=1.5,
        pitch=0,
        bearing=0
    )
    
    # ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ
    layers = [
        create_earth_layer(),
        create_day_night_layer(),
        create_city_markers_layer(),
        create_weather_layer(weather_data)
    ]
    
    # Deckã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
    deck = pydeck.Deck(
        layers=layers,
        initial_view_state=view_state,
        tooltip={'text': '{name}\n{temperature}Â°C\n{weather}'}
    )
    
    st.pydeck_chart(deck)
```

#### 5.1.3 æ¤œç´¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```python
def render_search_component():
    search_type = st.radio(
        "æ¤œç´¢æ–¹æ³•",
        ["éƒ½å¸‚åæ¤œç´¢", "ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ"],
        horizontal=True
    )
    
    if search_type == "éƒ½å¸‚åæ¤œç´¢":
        query = st.text_input(
            "éƒ½å¸‚åã‚’å…¥åŠ›",
            placeholder="Tokyo, London, Paris..."
        )
        
        if query:
            suggestions = geo_service.search_cities(query)
            selected_city = st.selectbox(
                "å€™è£œã‹ã‚‰é¸æŠ",
                suggestions,
                format_func=lambda x: f"{x.name_ja} ({x.country_ja})"
            )
            
    else:  # ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
        continent = st.selectbox(
            "å¤§é™¸ã‚’é¸æŠï¼ˆä»»æ„ï¼‰",
            ["ã™ã¹ã¦", "ã‚¢ã‚¸ã‚¢", "ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘", "åŒ—ã‚¢ãƒ¡ãƒªã‚«", "å—ã‚¢ãƒ¡ãƒªã‚«", "ã‚¢ãƒ•ãƒªã‚«", "ã‚ªã‚»ã‚¢ãƒ‹ã‚¢"]
        )
        
        if st.button("ãƒ©ãƒ³ãƒ€ãƒ éƒ½å¸‚ã‚’é¸æŠ", type="primary"):
            selected_city = geo_service.get_random_city(
                None if continent == "ã™ã¹ã¦" else continent
            )
            st.session_state.selected_city = selected_city
```

### 5.2 ã‚¹ã‚¿ã‚¤ãƒ«å®šç¾©

#### 5.2.1 ã‚«ã‚¹ã‚¿ãƒ CSS

```css
/* ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ */
.main-header {
    background: linear-gradient(135deg, #1E2A3A, #2C3E50);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    text-align: center;
}

.main-header h1 {
    color: #FFFFFF;
    font-size: 2.5rem;
    font-weight: 300;
    margin: 0;
}

/* å¤©æ°—æƒ…å ±ã‚«ãƒ¼ãƒ‰ */
.weather-card {
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    margin-bottom: 1rem;
}

.weather-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto;
    display: block;
}

.temperature {
    font-size: 3rem;
    font-weight: 300;
    text-align: center;
    color: #FFFFFF;
}

/* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
.search-container {
    background: rgba(255, 255, 255, 0.05);
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
}

/* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
.random-button {
    background: linear-gradient(45deg, #F5A623, #F39C12);
    border: none;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.random-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(245, 166, 35, 0.4);
}
```

## 6. è©³ç´°å‡¦ç†ãƒ•ãƒ­ãƒ¼

### 6.1 ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant U as User
    participant A as App
    participant GS as GeoService
    participant WS as WeatherService
    participant API as OpenWeatherMap
    
    U->>A: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
    A->>A: Streamlitè¨­å®šèª­ã¿è¾¼ã¿
    A->>GS: éƒ½å¸‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
    GS->>GS: cities.csvãƒ­ãƒ¼ãƒ‰
    A->>A: UIåˆæœŸåŒ–
    A->>U: åˆæœŸç”»é¢è¡¨ç¤º
```

### 6.2 éƒ½å¸‚æ¤œç´¢ãƒ»é¸æŠãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant U as User
    participant A as App
    participant GS as GeoService
    participant WS as WeatherService
    participant API as OpenWeatherMap
    participant C as Cache
    
    U->>A: éƒ½å¸‚åå…¥åŠ›
    A->>GS: search_cities(query)
    GS->>GS: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢
    GS->>A: å€™è£œãƒªã‚¹ãƒˆè¿”å´
    A->>U: å€™è£œè¡¨ç¤º
    
    U->>A: éƒ½å¸‚é¸æŠ
    A->>WS: get_current_weather(city)
    WS->>C: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
    
    alt ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ‰åŠ¹
        C->>WS: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿è¿”å´
    else ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹/ãªã—
        WS->>API: å¤©æ°—ãƒ‡ãƒ¼ã‚¿è¦æ±‚
        API->>WS: å¤©æ°—ãƒ‡ãƒ¼ã‚¿è¿”å´
        WS->>C: ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
    end
    
    WS->>A: å¤©æ°—ãƒ‡ãƒ¼ã‚¿è¿”å´
    A->>A: åœ°çƒå„€è¦–ç‚¹ç§»å‹•
    A->>A: å¤©æ°—æƒ…å ±è¡¨ç¤ºæ›´æ–°
    A->>U: æ›´æ–°ç”»é¢è¡¨ç¤º
```

### 6.3 æ˜¼å¤œå¢ƒç•Œç·šè¨ˆç®—ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    A[ç¾åœ¨æ™‚åˆ»å–å¾— UTC] --> B[å¤ªé™½èµ¤ç·¯è¨ˆç®—]
    B --> C[å„ç·¯åº¦ã§ã®æ—¥ã®å‡º/æ—¥ã®å…¥ã‚Šæ™‚åˆ»è¨ˆç®—]
    C --> D[æ˜¼å¤œå¢ƒç•Œç·šåº§æ¨™é…åˆ—ç”Ÿæˆ]
    D --> E[å¢ƒç•Œç·šã‚’Pydeckãƒ¬ã‚¤ãƒ¤ãƒ¼ã«å¤‰æ›]
    E --> F[åœ°çƒå„€ã«å¢ƒç•Œç·šãƒ¬ã‚¤ãƒ¤ãƒ¼è¿½åŠ ]
    F --> G[10åˆ†å¾Œã«å†è¨ˆç®—ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«]
```

## 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ

### 7.1 ã‚¨ãƒ©ãƒ¼åˆ†é¡ã¨å¯¾å¿œ

| ã‚¨ãƒ©ãƒ¼åˆ†é¡ | åŸå›  | å¯¾å¿œæ–¹æ³• | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡¨ç¤º |
|------------|------|----------|--------------|
| API_ERROR | OpenWeatherMap APIã‚¨ãƒ©ãƒ¼ | å†è©¦è¡Œ â†’ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ â†’ ã‚¨ãƒ©ãƒ¼è¡¨ç¤º | "å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ" |
| NETWORK_ERROR | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼ | å†è©¦è¡Œ â†’ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ | "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„" |
| DATA_ERROR | ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼ | ãƒ­ã‚°å‡ºåŠ› â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨ | "ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™" |
| VALIDATION_ERROR | å…¥åŠ›å€¤ã‚¨ãƒ©ãƒ¼ | å…¥åŠ›å€¤ã‚¯ãƒªã‚¢ â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º | "å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„" |

### 7.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…

```python
class ErrorHandler:
    @staticmethod
    def handle_api_error(error: Exception, context: str) -> Optional[dict]:
        """API ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"""
        logger.error(f"API Error in {context}: {str(error)}")
        
        if isinstance(error, requests.exceptions.Timeout):
            st.error("â±ï¸ å¿œç­”æ™‚é–“ãŒé•·ã™ãã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚")
        elif isinstance(error, requests.exceptions.ConnectionError):
            st.error("ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚")
        else:
            st.error("âŒ å¤©æ°—æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
        
        return None
    
    @staticmethod
    def handle_validation_error(error: ValidationError) -> None:
        """ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"""
        st.error(f"âš ï¸ å…¥åŠ›ã‚¨ãƒ©ãƒ¼: {error.message}")
    
    @staticmethod
    def handle_unexpected_error(error: Exception, context: str) -> None:
        """äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°"""
        logger.exception(f"Unexpected error in {context}")
        st.error("ğŸ˜µ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚")
```

## 8. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–è¨­è¨ˆ

### 8.1 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

```python
class CacheManager:
    def __init__(self):
        self.cache = {}
        self.cache_ttl = {
            'weather': 600,  # 10åˆ†
            'geocoding': 3600,  # 1æ™‚é–“
            'cities': 86400,  # 24æ™‚é–“
        }
    
    @st.cache_data(ttl=600)  # Streamlitã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½µç”¨
    def get_weather_data(self, city_id: int) -> Optional[WeatherData]:
        """å¤©æ°—ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥å–å¾—"""
        key = f"weather_{city_id}"
        return self._get_from_cache(key)
    
    def _get_from_cache(self, key: str) -> Optional[any]:
        """ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å–å¾—"""
        if key in self.cache:
            data, timestamp = self.cache[key]
            cache_type = key.split('_')[0]
            
            if time.time() - timestamp < self.cache_ttl.get(cache_type, 300):
                return data
            else:
                del self.cache[key]
        
        return None
```

### 8.2 ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–

```python
def optimize_rendering():
    """ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æœ€é©åŒ–è¨­å®š"""
    
    # Streamlitè¨­å®š
    st.set_option('client.showErrorDetails', False)
    st.set_option('client.toolbarMode', 'minimal')
    
    # Pydeckè¨­å®š
    pydeck.settings.use_binary_transport = True
    
    # ãƒ‡ãƒ¼ã‚¿åœ§ç¸®
    @st.cache_data
    def compress_city_data(df: pd.DataFrame) -> pd.DataFrame:
        """éƒ½å¸‚ãƒ‡ãƒ¼ã‚¿ã®æœ€é©åŒ–"""
        return df.round({'latitude': 4, 'longitude': 4})
```

## 9. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 9.1 APIã‚­ãƒ¼ç®¡ç†

```toml
# .streamlit/secrets.toml
[api_keys]
openweathermap = "your_api_key_here"

[settings]
debug_mode = false
max_requests_per_hour = 900
```

```python
class SecurityManager:
    @staticmethod
    def get_api_key() -> str:
        """å®‰å…¨ãªAPIã‚­ãƒ¼å–å¾—"""
        try:
            return st.secrets["api_keys"]["openweathermap"]
        except KeyError:
            st.error("ğŸ” APIè¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚")
            st.stop()
    
    @staticmethod
    def validate_input(user_input: str) -> str:
        """å…¥åŠ›å€¤ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³"""
        # SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–
        sanitized = re.sub(r'[^\w\s-]', '', user_input)
        # é•·ã•åˆ¶é™
        return sanitized[:100]
    
    @staticmethod
    def rate_limit_check() -> bool:
        """ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯"""
        if 'request_count' not in st.session_state:
            st.session_state.request_count = 0
            st.session_state.last_reset = time.time()
        
        # 1æ™‚é–“ã”ã¨ã«ãƒªã‚»ãƒƒãƒˆ
        if time.time() - st.session_state.last_reset > 3600:
            st.session_state.request_count = 0
            st.session_state.last_reset = time.time()
        
        if st.session_state.request_count >= 900:
            st.error("â° 1æ™‚é–“ã‚ãŸã‚Šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚")
            return False
        
        st.session_state.request_count += 1
        return True
```

## 10. ãƒ†ã‚¹ãƒˆè¨­è¨ˆ

### 10.1 å˜ä½“ãƒ†ã‚¹ãƒˆ

```python
import pytest
from unittest.mock import Mock, patch

class TestWeatherService:
    def test_get_current_weather_success(self):
        """å¤©æ°—ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸãƒ†ã‚¹ãƒˆ"""
        # Given
        weather_service = WeatherService()
        mock_response = {
            'main': {'temp': 25.5, 'humidity': 60},
            'weather': [{'main': 'Clear', 'description': 'clear sky'}]
        }
        
        # When
        with patch.object(weather_service.api_client, 'call_weather_api', 
                         return_value=mock_response):
            result = weather_service.get_current_weather('Tokyo')
        
        # Then
        assert result.temperature == 25.5
        assert result.weather_main == 'Clear'
    
    def test_get_current_weather_api_error(self):
        """API ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ"""
        # Given
        weather_service = WeatherService()
        
        # When
        with patch.object(weather_service.api_client, 'call_weather_api',
                         side_effect=requests.exceptions.Timeout()):
            result = weather_service.get_current_weather('InvalidCity')
        
        # Then
        assert result is None
```

### 10.2 çµåˆãƒ†ã‚¹ãƒˆ

```python
class TestIntegration:
    def test_full_weather_flow(self):
        """å¤©æ°—æƒ…å ±å–å¾—ãƒ•ãƒ« ãƒ•ãƒ­ãƒ¼ ãƒ†ã‚¹ãƒˆ"""
        # å®Ÿéš›ã®APIã‚’ä½¿ç”¨ã—ãŸçµåˆãƒ†ã‚¹ãƒˆ
        # ç’°å¢ƒå¤‰æ•°ã§ãƒ†ã‚¹ãƒˆç”¨APIã‚­ãƒ¼ã‚’è¨­å®š
        pass
    
    def test_ui_interaction(self):
        """UIæ“ä½œçµ±åˆãƒ†ã‚¹ãƒˆ"""
        # Streamlit ãƒ†ã‚¹ãƒˆç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
        pass
```

## 11. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­è¨ˆ

### 11.1 Streamlit Cloud ãƒ‡ãƒ—ãƒ­ã‚¤

```python
# requirements.txt
streamlit==1.28.0
pydeck==0.8.0
requests==2.31.0
pandas==2.0.0
numpy==1.24.0
pytz==2023.3
geopy==2.3.0
```

### 11.2 ç’°å¢ƒè¨­å®š

```python
# config.py
import os
from typing import Dict, Any

class Config:
    # ç’°å¢ƒåˆ¥è¨­å®š
    ENVIRONMENTS = {
        'development': {
            'debug': True,
            'cache_ttl': 60,  # 1åˆ†
            'max_requests': 100
        },
        'production': {
            'debug': False,
            'cache_ttl': 600,  # 10åˆ†
            'max_requests': 900
        }
    }
    
    @classmethod
    def get_config(cls) -> Dict[str, Any]:
        env = os.getenv('ENVIRONMENT', 'development')
        return cls.ENVIRONMENTS.get(env, cls.ENVIRONMENTS['development'])
```

ã“ã®è©³ç´°è¨­è¨ˆæ›¸ã«ã‚ˆã‚Šã€é–‹ç™ºãƒãƒ¼ãƒ ã¯å…·ä½“çš„ãªå®Ÿè£…ä½œæ¥­ã«ç€æ‰‹ã§ãã¾ã™ã€‚å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®è²¬å‹™ãŒæ˜ç¢ºã«åˆ†é›¢ã•ã‚Œã¦ãŠã‚Šã€ãƒ†ã‚¹ãƒˆå¯èƒ½ã§ä¿å®ˆã—ã‚„ã™ã„è¨­è¨ˆã¨ãªã£ã¦ã„ã¾ã™ã€‚